name: Post Changelog to Discord

on:
  workflow_dispatch:

jobs:
  send-changelog:
    if: github.ref == 'refs/heads/1.20.1'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout master branch
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Extract changelog section
        id: changelog
        run: |
          # Get branch name from GITHUB_REF (e.g. refs/heads/1.20.1)
          BRANCH_NAME="${GITHUB_REF##*/}"
          MODNAME="YourModName"  # Change to your actual mod name

          # Extract version from first heading (only numbers and dots)
          VERSION=$(grep -m1 '^# ' CHANGELOG.md | grep -oE '[0-9]+(\.[0-9]+)*')

          # Extract the section between the first '# ' and the next '# '
          CONTENT=$(awk '
            BEGIN {capture=0}
            /^# / {
              if (capture == 0) {capture=1; next}
              else {capture=0}
            }
            capture == 1 {print}
          ' CHANGELOG.md)

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "modname=$MODNAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          MODNAME="${{ steps.changelog.outputs.modname }}"
          VERSION="${{ steps.changelog.outputs.version }}"
          BRANCH="${{ steps.changelog.outputs.branch }}"
          CONTENT="${{ steps.changelog.outputs.content }}"

          MESSAGE="$MODNAME $VERSION for Fabric $BRANCH has been released!\n"
          MESSAGE+="Changelog\n"
          MESSAGE+="$CONTENT\n"
          MESSAGE+="Downloads\n"
          MESSAGE+="https://example.com/download1\n"
          MESSAGE+="https://example.com/download2\n"
          MESSAGE+="Have a great time!"

          jq -n \
            --arg username "Changelog Bot" \
            --arg content "$MESSAGE" \
            '{username: $username, content: $content}' \
          | curl -H "Content-Type: application/json" \
                 -X POST \
                 -d @- \
                 "$DISCORD_WEBHOOK_URL"
